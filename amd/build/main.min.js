define(["jquery","core/log","core/ajax","core/notification","core/templates","core/str"],function(a,b,c,d,e,f){return{init:function(){function a(a){a=a.parentNode;var b=JSON.parse(a.dataset.types),c=document.createElement("ul"),f={modaltitle:a.dataset.name};e.render(n.modalcontent,f).done(function(a,d){e.replaceNodeContents(t,a,d),q.querySelector(m.modalBody).innerHTML="",b.forEach(function(a){var b=q.querySelectorAll("li.activity."+a);b.forEach(function(a){c.appendChild(a.cloneNode(!0))})}),q.querySelector(m.modalBody).appendChild(c),s.click()}).fail(d.exception)}function g(a){for(;!a.classList.contains("indicator");)a=a.parentNode;var b=a,e=b.dataset.id;c.call([{methodname:"format_mytopcoll_delete_indicator",args:{indicatorid:Number(e)},done:function(){b.remove()},fail:d.exception}])}function h(a){a=a.parentNode,c.call([{methodname:"format_mytopcoll_get_edit_indicator",args:{courseid:Number(r.dataset.courseid),indicatorid:Number(a.dataset.id)||0},done:function(b){var c=JSON.parse(b);p.done(function(b){c.modaltitle=b[0],c.indicatorname=a.dataset.name||b[1],c.addnewindicator=a.dataset.id?0:1,e.render(n.modchooser,c).done(function(a,b){e.replaceNodeContents(t,a,b),s.click()}).fail(d.exception)})},fail:d.exception}])}function i(){var a=q.querySelector("#indchooserform"),b=[],e=a.dataset.indicatorid,f=Array.from(a.querySelectorAll("input[type=checkbox]:checked"));f.forEach(function(a){b.push(a.dataset.type)}),c.call([{methodname:"format_mytopcoll_set_edit_indicator",args:{courseid:Number(r.dataset.courseid),indicatorid:Number(e),data:JSON.stringify({modtypes:b})},done:function(a){if(a){var b=JSON.parse(a),c=r.querySelector('div[data-id="'+e+'"]');c.dataset.types=b.types,c.dataset.count=b.count,c.querySelector(".indicator_counter").innerHTML=b.count,c.querySelector(".indicator_new").innerHTML=b.hasnewactivity}else d.exception()},fail:d.exception}])}function j(a){var b=document.querySelector("#indicatornamedit"),e=document.querySelector("#indicatorname .srcname"),f=document.querySelector("#indicatorname"),g=document.querySelector("#indchooserform").dataset.indicatorid,h=r.querySelector('div[data-id="'+g+'"] .indicator_name');if("keypress"===a.type&&a.keyCode===o.enter)c.call([{methodname:"format_mytopcoll_update_indicator_name",args:{indicatorid:Number(g),indicatorname:b.value},done:function(a){a?(e.innerHTML=b.value,h.innerHTML=b.value,f.classList.remove("d-none"),b.classList.add("d-none")):d.exception()},fail:d.exception}]);else if("keypress"===a.type&&a.keyCode===o.escape)return f.classList.remove("d-none"),void b.classList.add("d-none")}function k(){var a=q.querySelector("#indchooserform"),b=[],e=Array.from(a.querySelectorAll("input[type=checkbox]:checked")),f=r.querySelector("#indicatornamedit").value;e.forEach(function(a){b.push(a.dataset.type)});var g={modtypes:b,name:f};c.call([{methodname:"format_mytopcoll_set_edit_indicator",args:{courseid:Number(r.dataset.courseid),indicatorid:Number(0),data:JSON.stringify(g)},done:function(a){if(a){var b=JSON.parse(a);l(b)}else d.exception()},fail:d.exception}])}function l(a){var b=document.querySelector(".indicator.example"),c=b.cloneNode(!0);c.dataset.id=a.id,c.dataset.name=a.name,c.dataset.types=a.types,c.dataset.count=a.count,c.querySelector(".indicator_new").innerHTML=a.hasnewactivity,c.querySelector(".indicator_counter").innerHTML=a.count,c.querySelector(".indicator_name").innerHTML=a.name,c.classList.remove("example","d-none"),c.classList.add("d-flex"),r.insertBefore(c,b)}b.debug("Indicator AMD load src/main");var m={indicator:".indicator_wrap",triggerModal:"#triggerModalIndicator",modalContent:"#modalContentIndicator",courseContent:".course-content",modalTitle:".modal-title",modalBody:".modal-body"},n={modalWrapper:"format_mytopcoll/modalwrapper",modalcontent:"format_mytopcoll/modalcontent",modchooser:"format_mytopcoll/modchooser"},o={enter:13,escape:27},p=f.get_strings([{key:"modchoose",component:"format_mytopcoll"},{key:"new",component:"format_mytopcoll"}]),q=document.querySelector(m.courseContent),r=q.querySelector(m.indicator),s=q.querySelector(m.triggerModal),t=q.querySelector(m.modalContent);r.addEventListener("click",function(b){for(var c=b.target;r.contains(c);){switch(c.dataset.handler){case"showActivityPopup":a(c);break;case"removeIndicator":g(c);break;case"getIndicatorData":h(c);break;case"setEditIndicator":i();break;case"addIndicator":k(c)}c=c.parentNode}}),r.addEventListener("keypress",function(a){var b=a.target;if("indicatornamedit"===b.dataset.handler)return void j(a)})}}});