define(["core/log","core/ajax","core/notification","core/templates","core/str"],function(a,b,c,d,e){return{init:function(){function f(a){var b=JSON.parse(a.dataset.indicator),e=document.createElement("ul"),f={modaltitle:a.dataset.name};d.render(m.modalcontent,f).done(function(a,c){d.replaceNodeContents(s,a,c),p.querySelector(l.modalBody).innerHTML="",b.forEach(function(a){var b=p.querySelectorAll("li.activity."+a);b.forEach(function(a){e.appendChild(a.cloneNode(!0))})}),p.querySelector(l.modalBody).appendChild(e),r.click()}).fail(c.exception)}function g(a){for(;!a.classList.contains("ind_item");)a=a.parentNode;b.call([{methodname:"format_mytopcoll_delete_indicator",args:{indicatorid:Number(a.dataset.id)},done:function(b){if(b){var d=document.querySelector(".ind_item[data-id='"+a.dataset.id+"']");d.remove()}else c.exception()},fail:c.exception}])}function h(a){a=a.parentNode,b.call([{methodname:"format_mytopcoll_get_edit_indicator",args:{courseid:Number(q.dataset.courseid),indicatorid:Number(a.dataset.id)||0},done:function(b){var e=JSON.parse(b);o.done(function(b){e.modaltitle=b[0],e.indicatorname=a.dataset.name||b[1],e.addnewindicator=a.dataset.id?0:1}),d.render(m.modchooser,e).done(function(a,b){d.replaceNodeContents(s,a,b),r.click()}).fail(c.exception)},fail:c.exception}])}function i(){var a=p.querySelector("#indchooserform"),d=[],e=a.dataset.indicatorid,f=Array.from(a.querySelectorAll("input[type=checkbox]:checked"));f.forEach(function(a){d.push(a.dataset.type)}),b.call([{methodname:"format_mytopcoll_set_edit_indicator",args:{courseid:Number(q.dataset.courseid),indicatorid:Number(e),data:JSON.stringify(d)},done:function(a){if(a){var b=q.querySelector('div[data-id="'+e+'"]');b.dataset.indicator=JSON.stringify(d)}else c.exception()},fail:c.exception}])}function j(a){var d=document.querySelector("#indicatornamedit"),e=document.querySelector("#indicatorname .srcname"),f=document.querySelector("#indicatorname"),g=document.querySelector("#indchooserform").dataset.indicatorid,h=q.querySelector('div[data-id="'+g+'"] .indicator_name');if("keypress"===a.type&&a.keyCode===n.enter)b.call([{methodname:"format_mytopcoll_update_indicator_name",args:{indicatorid:Number(g),indicatorname:d.value},done:function(a){a?(e.innerHTML=d.value,h.innerHTML=d.value,f.classList.remove("d-none"),d.classList.add("d-none")):c.exception()},fail:c.exception}]);else if("keypress"===a.type&&a.keyCode===n.escape)return f.classList.remove("d-none"),void d.classList.add("d-none")}function k(){var a=p.querySelector("#indchooserform"),d=document.querySelector(".addIndicator"),e=[],f=Array.from(a.querySelectorAll("input[type=checkbox]:checked")),g=q.querySelector("#indicatornamedit").value;f.forEach(function(a){e.push(a.dataset.type)});var h={types:e,name:g};b.call([{methodname:"format_mytopcoll_set_edit_indicator",args:{courseid:Number(q.dataset.courseid),indicatorid:Number(0),data:JSON.stringify(h)},done:function(a){if(a){var b=document.querySelector(".ind_item"),e=b.cloneNode(!0);e.querySelector(".indicator_name").innerHTML=g,e.dataset.id=a,e.dataset.name=g,e.dataset.indicator=h,q.insertBefore(e,d)}else c.exception()},fail:c.exception}])}a.debug("Indicator AMD load src/main");var l={indicator:".indicator_wrap",triggerModal:"#triggerModalIndicator",modalContent:"#modalContentIndicator",courseContent:".course-content",modalTitle:".modal-title",modalBody:".modal-body"},m={modalWrapper:"format_mytopcoll/modalwrapper",modalcontent:"format_mytopcoll/modalcontent",modchooser:"format_mytopcoll/modchooser"},n={enter:13,escape:27},o=e.get_strings([{key:"modchoose",component:"format_mytopcoll"},{key:"newindicator",component:"format_mytopcoll"}]),p=document.querySelector(l.courseContent),q=p.querySelector(l.indicator),r=p.querySelector(l.triggerModal),s=p.querySelector(l.modalContent);q.addEventListener("click",function(a){for(var b=a.target;!b.contains(q);){if("indicator"===b.dataset.handler)return void f(b);if("requestremoveindicator"===b.dataset.handler)return void g(b);if("geteditindicator"===b.dataset.handler)return void h(b);if("seteditindicator"===b.dataset.handler)return void i();if("addindicator"===b.dataset.handler)return void k();b=b.parentNode}}),q.addEventListener("keypress",function(a){var b=a.target;if("indicatornamedit"===b.dataset.handler)return void j(a)})}}});